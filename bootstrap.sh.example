#!/bin/bash
I_AM="{whoami}"
usermod -u $(id -u ${I_AM}) libertempo
groupmod -g $(id -g ${I_AM}) libertempo

echo "Starting mysql service"
sudo service mysql start

echo "Starting apache service"
sudo service apache2 start

sudo chown -R openldap: /etc/ldap
#chown -R openldap: /opt/run/content.ldif

echo "Starting ldap service"
ulimit -n 1024 && slapd -d1
sudo service slapd start

CMD="$(ldapsearch -x -LLL -H ldap:/// -b dc=libertempo dn)"
RETURN_VAL=$?
if [[ 0 != "${RETURN_VAL}" ]]; then
    echo "Boot ldap server"

    cat <<EOF | sudo debconf-set-selections
slapd slapd/internal/generated_adminpw password admin
slapd slapd/internal/adminpw password admin
slapd slapd/password2 password admin
slapd slapd/password1 password admin
slapd slapd/dump_database_destdir string /var/backups/slapd-VERSION
slapd slapd/domain string libertempo
slapd shared/organization string libertempo
slapd slapd/backend string HDB
slapd slapd/purge_database boolean true
slapd slapd/move_old_database boolean true
slapd slapd/allow_ldap_v2 boolean false
slapd slapd/no_configuration boolean false
slapd slapd/dump_database select when needed
EOF

    sudo dpkg-reconfigure -f noninteractive slapd
    sudo service slapd restart
fi

/bin/bash
